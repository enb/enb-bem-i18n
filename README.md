enb-bem-i18n
============

[![NPM version](http://img.shields.io/npm/v/enb-bem-i18n.svg?style=flat)](https://www.npmjs.org/package/enb-bem-i18n)
[![Build Status](http://img.shields.io/travis/enb-bem/enb-bem-i18n/master.svg?style=flat&label=tests)](https://travis-ci.org/enb-bem/enb-bem-i18n)
[![Build status](https://img.shields.io/appveyor/ci/blond/enb-bh.svg?style=flat&label=windows)](https://ci.appveyor.com/project/blond/enb-bh)
[![Coverage Status](https://img.shields.io/coveralls/enb-bem/enb-bem-i18n.svg?style=flat)](https://coveralls.io/r/enb-bem/enb-bem-i18n?branch=master)
[![devDependency Status](http://img.shields.io/david/enb-bem/enb-bem-i18n.svg?style=flat)](https://david-dm.org/enb-bem/enb-bem-i18n)

Пакет предоставляет набор ENB-технологий для сборки файлов, обеспечивающих мультиязыковую поддержку проектов, созданных на основе [БЭМ-методологии](https://ru.bem.info/method/). Под мультиязыковой поддержкой понимается интернационализация (далее по тектсу также `i18n`).

Технологии пакета `enb-bem-i18n` осуществляют сборку модуля для интернационализации (`i18n`) вашего проекта.

**Технологии пакета `enb-bem-i18n`:**

* [keysets](/api.ru.md#keysets) — служебная технология для сбора исходных файлов с переводами.
* [i18n-js](/api.ru.md#i18n-js) — технология, которая формирует отдельные бандлы с переводами для каждого языка для дальнейшего использования.
* [i18n-keysets-xml](/api.ru.md#i18n-keysets-xml) — технология для локализации сервисов, использующих XSLT для шаблонизации.

Принципы работы технологий и их API описаны в документе [API технологий](/api.ru.md).

**Совместимость:** пакет поддерживает следующие библиотеки:

* [bem-bl](https://ru.bem.info/libs/bem-bl/dev/)
* [bem-core](https://ru.bem.info/libs/bem-core/)

>Особенности реализации для каждой библиотеки описаны в разделе [подключение библиотек](#Поддержка-библиотек).

## Обзор документа

<!-- TOC -->
- [Установка](#Установка)
- [Особенности работы пакета](#Особенности-работы-пакета)
  - [Исходные данные](#Исходные-данные)
    - [keysets](#keysets)
    - [Расположение в файловой системе](#Расположение-в-файловой-системе)
    - [Ядро i18n](#Ядро-i18n)
- [Процесс сборки](#Процесс-сборки)
- [Использование](#Использование)
  - [Особенности поддержки библиотек](#Особенности-поддержки-библиотек)
  - [Подключение](#Подключение)
  - [Применение](#Применение)
    - [В шаблонах](#В-шаблонах)
    - [В JavaScript](#В-javascript)
- [API `i18n`](#api-i18n)
  - [В библиотеке `bem-bl` — `BEM.I18N`](#В-библиотеке-bem-bl--bemi18n)
  - [В библиотеке `bem-core` — `i18n`](#В-библиотеке-bem-core--i18n)
- [Отличия в работе](#Отличия-в-работе)

<!-- TOC END -->

## Установка

**Требования:** зависимость от пакета `enb` версии `0.11.0` или выше.

```
npm install --save-dev enb-bem-i18n
```

## Особенности работы пакета

### Исходные данные

#### keysets

`keysets` — исходные файлы с переводами, созданные для поддержки интернационализации. Перевод представляет собой набор ключей и их значений. Ключ определяет, какое из значений должно быть выбрано для указанного языка.

Пример:

```js
{
    hello: 'Привет!'
}
```
Набор данных `ключ: 'значение'` передается с указанием контекста `scope`. Обычно контекстом служит имя блока.

Пример:

```javascript
module.exports = {
    greeting: {
        hello: "Привет!"
    }
};
```

#### Расположение в файловой системе

Переводы (`keysets`) хранятся в файлах `<lang>.js` (например, `en.js`).

Файлы `<lang>.js` для каждой БЭМ-сущности находятся в отдельной директории `<имя-БЭМ-сущности>.i18n` наряду с другими файлами технологий.

```
block/
    block.i18n/
      ru.js
      en.js
```

Также есть возможность объединять переводы, одинаковые для всех языков, в общие файлы:
* В `bem-bl` общие переводы хранятся в файле `all.js`.
* В `bem-core` — в файле `<block-name>.i18n.js`.

```
common.blocks/
    block1/
        block1.js
        block1.bh
        block1.i18n/         # Директория для хранения файлов с переводами для разных языков.
            en.js            # Исходный файл с переводом для английского языка.
            ru.js            # Исходный файл с переводом для русского языка.
            all.js           # Исходный файл с переводом, содержащий одинаковые значения ключей для русского и английского языка. Может содержать ядро `i18n` для библиотеки `bem-bl`.
    block2/
        block2.js
        block2.bh
        block2.i18n/
            en.js
            ru.js
    block1.i18n.js           # Исходный файл с переводом, содержащий одинаковые значения ключей для всех языков. Может содержать ядро `i18n` для библиотеки `bem-core`.
```

#### Ядро i18n

Библиотека для интернационализации. Ядро находится в `keyset`-файлах (`<имя-БЭМ-сущности>.i18n.js` или `all.js`) в одной из базовых библиотек блоков:

* В `bem-bl` — это элемент блока `i-bem__i18n`.
* В `bem-core` — это блок `i18n`.

>Подробнее о расположении `keyset`-файлов, содержащих ядро, в файловой системе читайте в разделе [Расположение в файловой системе](#Расположение-в-файловой-системе).

Ядро `i18n` в библиотеках `bem-core` и `bem-bl` хранится в `keyset`-файлах по-разному:

В `bem-bl` (файл `all.js`):

```js
{
    all: {
        '': { // пустая строка
            /* код ядра */
        }
    }
}
```

В `bem-core` (файл `i18n.js`):

```js
{
    i18n: {
        i18n: {
            /* код ядра */
        }
    }
}
```
Перед использованием ядро должно быть инициализировано данными из `keyset`-файлов. Функция `i18n` принимает ключ с указанием контекста (`scope`) и отдает значение (строку), соответствующее выбранному языку.

>Подробно про API использования ядра `i18n` читайте в разделе [API `i18n`](#api-i18n).

## Процесс сборки

Данные из файлов `<lang>.js` во время сборки проходят несколько этапов:

* [Объединение данных исходных файлов в один для указанного языка](#first-step)
* [Обработка данных из объединенного файла и передача их в JavaScript](#second-step)

<a name="first-step"></a>
**Этап I**

Технология [keysets](/api.ru.md#keysets) объединяет исходные файлы `<lang>.js` для каждого языка в общий файл (`?.keysets.<lang>.js`). Набор языков, для которых будут собраны `?.keysets.<lang>.js`-файлы, задается с помощью опции [lang](#/api.ru.md#lang).

`?.keysets.<lang>.js`-файл — это промежуточный результат сборки, который в дальнейшем используется технологией [i18n-js](/api.ru.md#i18n-js).

Например, для блоков `greeting` и `login` результирующий `?.keysets.en.js`-файл будет собран следующим образом.

Исходный файл `en.js` блока `greeting`:

```js
module.exports = {
    "greeting": {
        "hello": "Hello",
        "unknown": "stranger"
    }
};
```

Исходный файл `en.js` блока `login`:

```js
module.exports = {
    "login": {
        "login": "Login",
        "pass": "Password"
    }
};
```

Результирующий `?.keysets.en.js`-файл:

```js
module.exports = {
    "greeting": {
        "hello": "Hello",
        "unknown": "stranger"
    },
    "login": {
        "login": "Login",
        "pass": "Password"
    }
};
```

>Примеры всех вариантов использования ядра рассмотрены в [тестах к технологии](https://github.com/enb-bem/enb-bem-i18n/blob/master/test/techs/i18n-merge-keysets.test.js).

<a name="second-step"></a>
**Этап II**

Данные из объединенного файла `?.keysets.<lang>.js` обрабатываются технологией [i18n-js](/api.ru.md#i18n-js). Результатом работы является функция `i18n`, которая при вызове из [шаблонов](#В-шаблонах) или [клиентского JavaScript](#В-javascript) принимает ключ и отдает значение (строку) для конкретного языка.

>API взаимодействия с ядром `i18n` описан в разделе [API `i18n`](#api-i18n).
Результатом являются `lang.<lang>.js`-файлы, содержащие строки переводов, соответствующие запрошенным ключам.

## Использование

### Особенности поддержки библиотек

Пакет `enb-bem-i18n` поддерживает две реализации интернационализации:

* В библиотеке `bem-bl` — ядро `BEM.I18N`.
* В библиотеке `bem-core@v3` — ядро `i18n`.

### Подключение

Результат сборки — скомпилированный `?.lang.<lang>.js`-файлы для отдельных языков могут применяться следующим образом:

* Использовать в Node.js как CommonJS-модуль.<br>
```js
var i18n = require('bundle.lang.en.js'); // Путь до скомпилированного файла

i18n('scope', 'key');
```

* Использовать в браузере с YModules как `i18n-модуль.

```js
modules.require('i18n', function (i18n) {
    i18n('scope', 'key'); // val
});
```
* Использовать в браузере без YModules как `BEM.I18N`.

```js
BEM.I18N('scope', 'key');
```

Ядро `BEM.I18N` в `bem-bl` предоставляется в глобальную видимость в переменную `BEM.I18N`.

Ядро `i18n` подключается в модульную систему ([YModules](https://ru.bem.info/tools/bem/modules/), если она используется в проекте, или [CommonJS](http://www.commonjs.org/)) как отдельный модуль с именем `i18n`.

>**Важно!** В проект с модульной системой ядро библиотеки интернационализации подключаются одинаково, как модуль `i18n`, вне зависимости от используемой библиотеки `bem-core` или `bem-bl`.

### Применение

**Функция `i18n` может использоваться:**

* [в шаблонах](#В-шаблонах)
* [в JavaScript](#В-javascript)

#### В шаблонах

**Для библиоткеи `bem-bl`**

В BEMHTML:

```javascript
block('block').content()(function() {
    return {
        elem: 'tooltip',
        content: BEM.I18N('block', 'tooltip');
    };
});
```

В BH:

```
bh.match('block', function (ctx) {
    ctx.content({
        elem: 'tooltip',
        content: bh.lib.i18n('block', 'tooltip');
    });
});
```

**Для библиоткеи `bem-core`**

В BEMHTML функция `i18n` доступна через `this.i18n`:

```js
block('block').content()(function() {
    return {
        elem: 'tooltip',
        content: this.i18n('block', 'tooltip');
    };
});
```

В BH:

```
bh.match('block', function (ctx) {
    ctx.content({
        elem: 'tooltip',
        content: bh.lib.i18n('block', 'tooltip');
    });
});
```

Для работы с разными языками используется один шаблон. Язык указывается в [опциях](#lang) технологии сборки и определяет, на основании каких `?.keysets.<lang>.js`-файлов создавать файл с переводом `lang.<lang>.js`.

#### В JavaScript

Подключается как модуль `i18n` модульной системы YModules:

```js
modules.require('i18n', function (i18n) {
    i18n('scope', 'key'); // val
});
```

## API `i18n`

Функция принимает следующие параметры:

* **scope** — область видимости ключа. Обычно имя блока.
* **key** — ключ, соответствующий значению для указанного языка.

Результат выполнения: строка, содержащая перевод.

### В библиотеке `bem-bl` — `BEM.I18N`

Тип: `String`.

Возможность параметризации значений реализована через XML. В строку передается XML, который обрабатывается с помощью специальной программы.

```js
var core = /* ... */,
    keyset = {
        hello: "Привет!"
    },
    lang = 'ru';

core.decl('greeting', keyset, lang);
core.lang(lang);

core('greeting', 'hello'); // Привет!
```

### В библиотеке `bem-core` — `i18n`

Тип: `String | Function`.

Задавать значения ключей можно не только как строку. Параметризация значений реализуется через функцию.

Пример 1:
```js
{
    'scope-1': {
        key: 'val'
    },
    'scope-2': {
        key: function (params, i18n) {
            return i18n(params.scope, params.key);
        }
    }
}
```

```js
modules.require('i18n', function (i18n) {
    i18n('scope-2', 'key', { scope: 'scope-1', key: 'key' }); // Значение
});
```

Пример 2:

API ядра `bem-core`:

```js
var core = /* ... */,
    keysets = {
        greeting: {
            hello: "Привет!"
        }
    };

var i18n = core().decl(keysets);

i18n('greeting', 'hello'); // Привет!
```

## Отличия в работе

Переключение между языками во время исполнения

* В `bem-bl` реализована возможность переключения между языками в реальном времени.
* В `bem-core` такой возможности нет.


© 2014 YANDEX LLC. Код лицензирован [Mozilla Public License 2.0](LICENSE.txt).
